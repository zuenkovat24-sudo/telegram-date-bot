import os
import re
import json
import logging
from datetime import datetime
import gspread
from google.oauth2.service_account import Credentials
from flask import Flask
from threading import Thread

from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, ContextTypes, filters

# === –ù–ê–°–¢–†–û–ô–ö–ò ===
logging.basicConfig(level=logging.INFO)
DATE_FORMAT = "%d.%m.%Y"
SPREADSHEET_ID = os.getenv("SPREADSHEET_ID", "1QzDByPjicYRB4csPMui86twJo8zcg5Ohq7KZDs5Yccg")
ADMIN_GROUP_ID = -1002925585648

# === GOOGLE SHEETS ===
def get_sheet():
    """–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Sheets —á–µ—Ä–µ–∑ JSON –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è"""
    scopes = ["https://www.googleapis.com/auth/spreadsheets"]
    service_account_info = os.getenv("SERVICE_ACCOUNT")

    if not service_account_info:
        raise RuntimeError("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è SERVICE_ACCOUNT!")

    creds_dict = json.loads(service_account_info)
    creds = Credentials.from_service_account_info(creds_dict, scopes=scopes)
    gc = gspread.authorize(creds)
    sh = gc.open_by_key(SPREADSHEET_ID)
    return sh.sheet1

# === –ü–†–û–í–ï–†–ö–ê –§–û–†–ú–ê–¢–ê –î–ê–¢–´ ===
def is_valid_date(text: str) -> bool:
    if not re.fullmatch(r"\s*\d{2}\.\d{2}\.\d{4}\s*", text):
        return False
    try:
        datetime.strptime(text.strip(), DATE_FORMAT)
        return True
    except ValueError:
        return False

# === –ö–û–ú–ê–ù–î–ê /start ===
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "üéÄ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å—Ç—É–¥–∏—é –¥–µ–∫–æ—Ä–∞ *SVETLANA TELKOVA*!\n\n"
        "–ú—ã —Å–æ–∑–¥–∞—ë–º –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –ø—Ä–∞–∑–¥–Ω–∏–∫–∞ —Å –ª—é–±–æ–≤—å—é –∏ –≤–Ω–∏–º–∞–Ω–∏–µ–º –∫ –¥–µ—Ç–∞–ª—è–º üíê\n"
        "–û—Ñ–æ—Ä–º–ª—è–µ–º –ø—Ä–µ–∑–∏–¥–∏—É–º—ã, —Ñ–æ—Ç–æ–∑–æ–Ω—ã, –¥–µ–∫–æ—Ä –¥–ª—è —á–∞—Å—Ç–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –±–∏–∑–Ω–µ—Å–∞.\n\n"
        "üìÖ –≠—Ç–æ—Ç –±–æ—Ç –ø–æ–º–æ–∂–µ—Ç —É–∑–Ω–∞—Ç—å, —Å–≤–æ–±–æ–¥–Ω–∞ –ª–∏ –Ω—É–∂–Ω–∞—è –¥–∞—Ç–∞ –¥–ª—è –≤–∞—à–µ–≥–æ —Å–æ–±—ã—Ç–∏—è.\n\n"
        "–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì (–Ω–∞–ø—Ä–∏–º–µ—Ä 25.12.2025)",
        parse_mode="Markdown"
    )

# === –ü–†–û–í–ï–†–ö–ê –î–ê–¢–´ ===
async def check_date(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text.strip()
    user = update.message.from_user
    username = f"@{user.username}" if user.username else user.full_name

    if not is_valid_date(text):
        await update.message.reply_text(
            "–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì (–Ω–∞–ø—Ä–∏–º–µ—Ä 05.11.2025)"
        )
        return

    date_str = datetime.strptime(text, DATE_FORMAT).strftime(DATE_FORMAT)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É
    try:
        sheet = get_sheet()
        dates = sheet.col_values(1)
        booked = set(d.strip() for d in dates[1:] if d.strip())
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ Google Sheets: {e}")
        await update.message.reply_text("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ —Ç–∞–±–ª–∏—Ü–µ.")
        return

    # –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    if date_str in booked:
        user_reply = (
            f"‚ùå –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –¥–∞—Ç–∞ {date_str} —É–∂–µ –∑–∞–Ω—è—Ç–∞.\n"
            "–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—Ä—É–≥—É—é –¥–∞—Ç—É –∏–ª–∏ –Ω–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º:\n"
            "[vk.me/vostorg_dzr](https://vk.me/vostorg_dzr)"
        )
        status = "‚ùå –ó–ê–ù–Ø–¢–ê"
    else:
        user_reply = (
            f"‚úÖ –î–∞—Ç–∞ {date_str} —Å–≤–æ–±–æ–¥–Ω–∞!\n"
            "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–Ω–∫–µ—Ç—É:\n"
            "[–û—Ç–∫—Ä—ã—Ç—å –∞–Ω–∫–µ—Ç—É](https://vk.com/app5619682_-220942261#713509)\n\n"
            "–õ–∏–±–æ –Ω–∞–ø–∏—à–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:\n"
            "–í–ö: [https://vk.me/vostorg_dzr](https://vk.me/vostorg_dzr)\n"
            "–¢–ì: @TelkovaSvetlana\n\n"
            "_P.S.: –ï—Å–ª–∏ –º—ã —Å –≤–∞–º–∏ –Ω–µ —Å–≤—è–∑—ã–≤–∞–µ–º—Å—è, –≤–æ–∑–º–æ–∂–Ω–æ —É –≤–∞—Å —Å—Ç–æ–∏—Ç –∑–∞–ø—Ä–µ—Ç –Ω–∞ –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è._\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –ø–µ—Ä–≤—ã–º–∏ üí¨"
        )
        status = "‚úÖ –°–í–û–ë–û–î–ù–ê"

    await update.message.reply_text(user_reply, parse_mode="Markdown")

    # === –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –í –ì–†–£–ü–ü–£ –ê–î–ú–ò–ù–û–í ===
    try:
        if user.username:
            contact_link = f"[{username}](https://t.me/{user.username})"
        else:
            contact_link = f"{user.full_name} (ID: `{user.id}`)"

        now = datetime.now().strftime("%d.%m.%Y %H:%M")

        admin_message = (
            "üì© *–ù–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã!*\n\n"
            f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {contact_link}\n"
            f"üìÖ –î–∞—Ç–∞: {date_str}\n"
            f"üïí –í—Ä–µ–º—è: {now}\n"
            f"üìä –°—Ç–∞—Ç—É—Å: {status}"
        )

        await context.bot.send_message(
            chat_id=ADMIN_GROUP_ID,
            text=admin_message,
            parse_mode="Markdown"
        )

    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ –≥—Ä—É–ø–ø—É –∞–¥–º–∏–Ω–æ–≤: {e}")

# === FLASK keep-alive –¥–ª—è Render ===
app = Flask(__name__)

@app.route('/')
def home():
    return "Bot is alive!"

def run_web():
    app.run(host='0.0.0.0', port=10000)

def keep_alive():
    t = Thread(target=run_web)
    t.start()

# === –¢–û–ß–ö–ê –í–•–û–î–ê ===
def main():
    token = os.getenv("BOT_TOKEN")
    if not token:
        raise RuntimeError("–ù–µ –Ω–∞–π–¥–µ–Ω BOT_TOKEN. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è.")

    app_telegram = Application.builder().token(token).build()

    app_telegram.add_handler(CommandHandler("start", start))
    app_telegram.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, check_date))

    print("ü§ñ Bot is running...")
    app_telegram.run_polling(close_loop=False)

if __name__ == "__main__":
    keep_alive()  # üëà –∑–∞–ø—É—Å–∫–∞–µ—Ç Flask, —á—Ç–æ–±—ã Render –Ω–µ –≤—ã–¥–∞–≤–∞–ª –æ—à–∏–±–∫—É –ø–æ—Ä—Ç–∞
    main()



